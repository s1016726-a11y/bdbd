<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ’å–®ç®¡ç†ç³»çµ± V27 (é›²ç«¯æ‰‹æ©Ÿç‰ˆ)</title>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
  /* --- 1. å…¨å±€è¨­å®š --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; background: #f4f6f9; overflow: hidden; position: relative; }
  
  /* å·¦å´æ¬„ (æ¡Œé¢ç‰ˆå›ºå®šï¼Œæ‰‹æ©Ÿç‰ˆçµ•å°å®šä½) */
  #sidebar {
    width: 320px; background: white; border-right: 1px solid #ddd; display: flex;
    flex-direction: column; padding: 15px; z-index: 2000; 
    flex-shrink: 0; 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* æ»‘å‹•å‹•ç•« */
    position: relative; height: 100%;
  }
  
  /* å³å´è¡Œäº‹æ›†å€ */
  #calendar-wrap { flex: 1; padding: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden;}
  #calendar { background: white; padding: 10px; border-radius: 8px; flex: 1; box-shadow: 0 0 15px rgba(0,0,0,0.05); }

  /* é›²ç«¯ç‹€æ…‹ç‡ˆ */
  #cloud-status { font-size: 0.8rem; font-weight: normal; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; float:right;}

  /* --- 2. å…ƒä»¶æ¨£å¼ --- */
  h2 { margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
  
  .form-box { background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; margin-bottom: 10px; }
  .input-row { margin-bottom: 8px; }
  input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
  
  .labeled-input { display: flex; align-items: center; background: white; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
  .labeled-input span { background: #e9ecef; padding: 8px; font-size: 0.85rem; color: #555; font-weight: bold; border-right: 1px solid #ccc; white-space: nowrap;}
  .labeled-input input { border: none; padding: 8px; width: 100%; outline: none; }

  .color-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
  .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
  .color-dot.active { border-color: #333; transform: scale(1.15); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  button.btn-main { width: 100%; background: #0d6efd; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;}
  button.btn-main:hover { background: #0b5ed7; }
  .btn-group { display: flex; gap: 5px; margin-top: 10px; }

  .settings-box { background: #eef2f7; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.85rem; font-weight: bold; color: #333;}
  .settings-box label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
  
  .filter-select { margin-bottom: 10px; background-color: #fff3cd; font-weight: bold; color: #856404; }
  #external-events { flex: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 50px; }
  
  /* å¡ç‰‡æ¨£å¼ */
  .fc-event { cursor: grab; padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #ddd; border-left-width: 5px; border-radius: 4px; position: relative; user-select: none; touch-action: manipulation; }
  .event-content { padding-right: 20px; } 
  .event-title { font-weight: bold; font-size: 1rem; color: #333; }
  .event-meta { font-size: 0.75rem; color: #666; margin-top: 2px; display: flex; gap: 5px; flex-wrap: wrap;}
  .del-btn { position: absolute; top: 8px; right: 8px; color: #ff6b6b; cursor: pointer; font-weight: bold; padding: 5px; }

  /* é ‚éƒ¨é¢æ¿ */
  #top-panel { position: absolute; top: 15px; right: 20px; z-index: 100; background: white; padding: 6px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #ddd; display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
  .countdown-wrap { display: flex; align-items: center; gap: 5px; border-left: 1px solid #ddd; padding-left: 10px;}
  #countdown_output { font-weight: bold; color: #0d6efd; min-width: 60px; text-align: center; }

  /* FullCalendar æ¨£å¼è¦†è“‹ */
  .fc-event { font-size: 11px !important; border: none !important; }
  .fc-event-main-frame { padding: 2px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
  .fc-col-header-cell { color: #333 !important; padding: 5px 0 !important; }
  .fc-col-header-cell-c a { display: block !important; font-weight: bold; color: inherit; text-decoration: none;}
  .fc-daygrid-day-number { color: #333 !important; font-weight: bold; font-size: 0.9rem; padding: 2px 4px; z-index: 2; text-decoration: none;}
  .fc-toolbar-title { font-size: 1.2rem !important; }
  .cal-row { display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: hidden; }
  .cal-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 4px; }
  .cal-meta { font-size: 10px; white-space: nowrap; opacity: 0.9; flex-shrink: 0; }

  /* --- 3. è¡Œå‹•è£ç½®å°ˆå±¬ (Mobile Styles) --- */
  
  /* æµ®å‹•æŒ‰éˆ• (FAB) */
  #fab {
      display: none; 
      position: fixed; bottom: 25px; right: 25px; z-index: 2100;
      width: 56px; height: 56px; border-radius: 50%; background: #0d6efd;
      color: white; border: none; font-size: 32px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer;
      align-items: center; justify-content: center;
      transition: transform 0.2s;
  }
  #fab:active { transform: scale(0.95); }

  /* æ‰‹æ©Ÿé®ç½©å±¤ */
  #mobile-overlay {
      display: none; position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); z-index: 1900; opacity: 0; transition: opacity 0.3s;
  }
  #mobile-overlay.visible { opacity: 1; }

  @media (max-width: 768px) {
    body { flex-direction: column; }
    
    /* å´é‚Šæ¬„è®Šæˆæ»‘å‡ºå¼æŠ½å±œ */
    #sidebar { 
        position: absolute; top: 0; left: 0; 
        width: 85%; max-width: 320px; height: 100%; 
        transform: translateX(-100%); /* é è¨­éš±è—åœ¨å·¦å´ */
        box-shadow: 2px 0 12px rgba(0,0,0,0.2);
    }
    #sidebar.open { transform: translateX(0); } /* æ»‘å‡º */

    /* è¡Œäº‹æ›†å…¨å± */
    #calendar-wrap { padding: 0; height: 100%; }
    #calendar { border-radius: 0; padding: 0 5px; box-shadow: none; }
    .fc-header-toolbar { margin-bottom: 10px !important; padding-top: 10px; }

    /* é¡¯ç¤º FAB */
    #fab { display: flex; }
    
    /* èª¿æ•´é ‚éƒ¨é¢æ¿ä½ç½® */
    #top-panel { position: static; margin: 0; padding: 10px; border-bottom: 1px solid #eee; border-radius: 0; box-shadow: none; width: 100%; justify-content: space-between;}
    .countdown-wrap { border-left: none; padding-left: 0; }
  }
</style>
</head>
<body>

<button id="fab" onclick="toggleSidebar()">ï¼‹</button>
<div id="mobile-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <h2> æ’å–® V27 <span id="cloud-status">é€£ç·šä¸­...</span></h2>

  <div class="settings-box"><label><input type="checkbox" id="chk_schedule_sunday" checked> æ‹–æ›³æ’ç¨‹è‡ªå‹•é¿é–‹é€±æ—¥</label></div>

  <div id="add-box" class="form-box">
    <div class="input-row"><input id="t_title" class="enter-submit" type="text" placeholder="è¼¸å…¥æ¡ˆå"></div>
    <div class="input-row">
      <select id="t_cat" class="enter-submit">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="t_note" class="enter-submit" type="text" placeholder="å‚™è¨» (é¸å¡«)"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="t_days" class="enter-submit" type="number" min="1" value="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="t_ppl" class="enter-submit" type="number" min="1" value="1"></div>
    </div>
    <div class="color-row" id="color-row"></div>
    <button class="btn-main" onclick="addEvent()">ï¼‹ æ–°å¢æ¡ˆä»¶ (Enter)</button>
  </div>

  <div id="edit-box" class="form-box" style="display:none; border: 2px solid #0d6efd;">
    <div style="color:#0d6efd; font-weight:bold; margin-bottom:5px;"> ğŸ“ ç·¨è¼¯æ¡ˆä»¶</div>
    <input type="hidden" id="e_id"><input type="hidden" id="e_source"> 
    <div class="input-row"><input id="e_title" type="text"></div>
    <div class="input-row">
      <select id="e_cat">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="e_note" type="text" placeholder="å‚™è¨»"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="e_days" type="number" min="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="e_ppl" type="number" min="1"></div>
    </div>
    <div class="color-row" id="edit-color-row"></div>
    <div class="btn-group">
      <button class="btn-main" onclick="confirmUpdate()">ç¢ºèª</button>
      <button class="btn-main" style="background:#dc3545; display:none;" id="btn-del-cal" onclick="deleteFromCalendar()">åˆªé™¤</button>
      <button class="btn-main" style="background:#6c757d" onclick="hideEditForm()">å–æ¶ˆ</button>
    </div>
  </div>

  <select id="filter_cat" class="filter-select" onchange="renderPending()">
    <option value="ALL">é¡¯ç¤ºå…¨éƒ¨</option>
    <option value="å¯å®‰æ’">å¯å®‰æ’</option>
    <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
    <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
    <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
  </select>

  <div id="external-events"></div>
</div>

<div id="calendar-wrap">
  <div id="top-panel">
    <label title="å€’æ•¸å¤©æ•¸æ˜¯å¦è¦æ‰£é™¤é€±æ—¥ï¼Ÿ">
      <input type="checkbox" id="chk_timer_sunday" checked onchange="updateCountdown(true)"> å€’æ•¸æ‰£é™¤é€±æ—¥
    </label>
    <div class="countdown-wrap">
      <span> ğŸ“… </span>
      <input type="date" id="countdown_date" style="width:auto; padding:2px;" onchange="updateCountdown(true)">
      <span id="countdown_output">...</span>
    </div>
  </div>
  <div id="calendar"></div>
</div>

<script type="module">
// ------------------------------------------------
// 1. Firebase åˆå§‹åŒ– (é›²ç«¯å¤§è…¦)
// ------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIqvMrXiRKl50Z_ZAZtn1UVAqpnnlnVmI",
  authDomain: "project-2936455536954733138.firebaseapp.com",
  projectId: "project-2936455536954733138",
  storageBucket: "project-2936455536954733138.firebasestorage.app",
  messagingSenderId: "248829609752",
  appId: "1:248829609752:web:de5e3882d215514d34406d"
};

let db;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    console.log("Firebase initialized");
} catch (e) {
    console.error("Firebase init failed:", e);
    document.getElementById('cloud-status').innerText = "è¨­å®šéŒ¯èª¤";
    document.getElementById('cloud-status').style.background = "#ffcccc";
}

// å•Ÿå‹•é›²ç«¯ç›£è½
if(db) {
    const statusEl = document.getElementById('cloud-status');
    onSnapshot(doc(db, "sch_system", "data"), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            statusEl.innerText = "å·²åŒæ­¥"; statusEl.style.color = "green";
            
            // æ›´æ–°æ¸…å–®
            window.pendingList = data.pending || [];
            window.renderPending();
            
            // æ›´æ–°è¡Œäº‹æ›† (é˜²æ­¢é–ƒçˆ)
            if(window.calendarAPI) {
                const currentEvents = window.calendarAPI.getEvents();
                // ç°¡å–®æ¯”å°ï¼šå¦‚æœæ•¸é‡ä¸åŒæˆ–å¼·åˆ¶é‡æ–°è¼‰å…¥ (é€™è£¡ç°¡åŒ–ç‚ºç›´æ¥é‡è¼‰ï¼Œå¯¦éš›å¯åšæ›´ç´°ç·»æ¯”å°)
                window.calendarAPI.removeAllEvents();
                window.calendarAPI.addEventSource(data.events || []);
            }

            // æ›´æ–°å€’æ•¸
            if(data.countdown) {
                document.getElementById('countdown_date').value = data.countdown;
                window.updateCountdown(false); 
            }
        } else { statusEl.innerText = "ç„¡è³‡æ–™"; }
    });
}

// å®šç¾©é›²ç«¯å„²å­˜å‡½å¼
window.saveToCloud = async function() {
    if (!db) return;
    const statusEl = document.getElementById('cloud-status');
    statusEl.innerText = "å„²å­˜ä¸­...";
    
    const currentPending = window.pendingList || [];
    const currentEvents = window.calendarAPI ? window.calendarAPI.getEvents().map(e => ({
        id: e.id, title: e.title, start: e.startStr, end: e.endStr, allDay: e.allDay,
        backgroundColor: e.backgroundColor, extendedProps: e.extendedProps
    })) : [];
    const currentCountdown = document.getElementById('countdown_date').value;

    try {
        await setDoc(doc(db, "sch_system", "data"), {
            pending: currentPending, events: currentEvents, countdown: currentCountdown, lastUpdate: new Date().toISOString()
        });
        statusEl.innerText = "å·²åŒæ­¥";
    } catch (e) {
        console.error("å¯«å…¥å¤±æ•—", e); statusEl.innerText = "å¯«å…¥å¤±æ•—";
    }
};
</script>

<script>
// ------------------------------------------------
// 2. é‚è¼¯æ§åˆ¶ (UI & æ“ä½œ)
// ------------------------------------------------
const COLORS = ['#3788d8', '#28a745', '#dc3545', '#ffc107', '#6610f2', '#fd7e14'];
let curColor = COLORS[0], editCurColor = COLORS[0]; 
let calendarAPI, sortableInstance;
window.pendingList = []; 
let editObj = null, editSource = '';

document.addEventListener('DOMContentLoaded', () => {
    initColors();
    initEnterKey();
    
    // SortableJS
    let listEl = document.getElementById('external-events');
    sortableInstance = Sortable.create(listEl, {
        animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
        forceFallback: true, onEnd: saveListOrder
    });

    // FullCalendar Drag
    new FullCalendar.Draggable(listEl, {
        itemSelector: '.fc-event',
        eventData: (el) => JSON.parse(el.getAttribute('data-event'))
    });
    
    // Calendar Init
    let calEl = document.getElementById('calendar');
    calendarAPI = new FullCalendar.Calendar(calEl, {
        headerToolbar: { 
            left: 'customMenu,prev,next', center: 'title', right: 'dayGridMonth' 
        },
        customButtons: {
            customMenu: { text: 'â˜°', click: toggleSidebar } // æ‰‹æ©Ÿç‰ˆæ¼¢å ¡é¸å–®
        },
        locale: 'zh-tw', editable: true, droppable: true,
        dayMaxEvents: 4, height: '100%', contentHeight: 'auto',
        initialEvents: [], // ç­‰å¾…é›²ç«¯è¼‰å…¥
        
        eventReceive: (info) => {
            if(!info.event.id) info.event.setProp('id', 'evt_' + Date.now());
            if(document.getElementById('chk_schedule_sunday').checked) calcWorkDays(info);
            removePending(info.event.extendedProps.sid); 
            window.saveToCloud();
        },
        eventChange: (info) => {
            if(document.getElementById('chk_schedule_sunday').checked && (info.revert || info.oldEvent)) calcWorkDays(info);
            window.saveToCloud();
        },
        eventClick: (info) => openEdit(info.event, 'calendar'),
        eventDragStop: (info) => {
            // åˆ¤æ–·æ˜¯å¦æ‹–æ›³å›å´é‚Šæ¬„ (æ¡Œé¢ç‰ˆæœ‰æ•ˆ)
            let sidebar = document.getElementById('sidebar');
            let rect = sidebar.getBoundingClientRect();
            let x = info.jsEvent.clientX, y = info.jsEvent.clientY;
            // å¦‚æœå´é‚Šæ¬„æ˜¯é¡¯ç¤ºç‹€æ…‹ï¼Œä¸”æ‹–æ›³é€²å»
            if (sidebar.offsetParent !== null && x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                if(confirm('ç¢ºå®šé€€å›æ¸…å–®ï¼Ÿ')) {
                    let p = info.event.extendedProps;
                    addPendingItem({
                        id: p.sid || ('p_' + Date.now()), title: info.event.title, 
                        cat: p.cat, note: p.note, days: p.days, ppl: p.ppl, color: info.event.backgroundColor
                    });
                    info.event.remove();
                    window.saveToCloud();
                }
            }
        },
        eventContent: (arg) => {
            let p = arg.event.extendedProps;
            let textColor = (arg.event.backgroundColor === '#ffc107') ? 'black' : 'white';
            return { html: `<div class="cal-row" style="color:${textColor}"><div class="cal-title">${arg.event.title}</div><div class="cal-meta"> ${p.days||1}å¤© ${p.ppl||1}äºº</div></div>` };
        },
        dayCellContent: (arg) => { 
            if (arg.dayNumberText) return { html: `<span class="fc-daygrid-day-number">${arg.dayNumberText.replace('æ—¥', '')}</span>` };
            return arg.domNodes;
        },
        dayHeaderFormat: { weekday: 'short' }
    });
    window.calendarAPI = calendarAPI;
    calendarAPI.render();
});

// --- UI é‚è¼¯ (æ‰‹æ©Ÿ) ---
function isMobile() { return window.matchMedia("(max-width: 768px)").matches; }

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    if (!isMobile()) { 
         sidebar.style.display = (sidebar.style.display === 'none') ? 'flex' : 'none';
         setTimeout(() => calendarAPI.updateSize(), 200);
         return;
    }

    const isOpen = sidebar.classList.contains('open');
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('visible');
        setTimeout(() => overlay.style.display = 'none', 300);
    } else {
        overlay.style.display = 'block';
        setTimeout(() => {
            sidebar.classList.add('open');
            overlay.classList.add('visible');
        }, 10);
        // é–‹å•Ÿæ™‚é‡ç½®ç‚ºæ–°å¢æ¨¡å¼
        document.getElementById('add-box').style.display = 'block';
        document.getElementById('edit-box').style.display = 'none';
    }
}

// --- æ ¸å¿ƒé‚è¼¯ ---
function calcWorkDays(info) {
    let p = info.event.extendedProps;
    let days = parseInt(p.days) || 1;
    let date = new Date(info.event.start);
    let count = 0;
    while(count < days) {
        if(date.getDay() !== 0) count++; // éé€±æ—¥æ‰ç®—å·¥æœŸ
        date.setDate(date.getDate() + 1);
    }
    // ç¢ºä¿çµæŸæ—¥ä¸ç‚ºé€±æ—¥
    while(date.getDay() === 0) date.setDate(date.getDate() + 1);
    
    info.event.setEnd(date);
    if(!info.event.allDay) info.event.setAllDay(true);
}

window.updateCountdown = function(isWrite = false) {
    if(isWrite && window.saveToCloud) window.saveToCloud();
    let input = document.getElementById('countdown_date');
    let output = document.getElementById('countdown_output');
    if(!input.value) { output.textContent = "..."; return; }
    
    let target = new Date(input.value); target.setHours(0,0,0,0);
    let now = new Date(); now.setHours(0,0,0,0);
    let diff = target.getTime() - now.getTime();
    
    if(diff >= 0) {
        let d = 0;
        if(document.getElementById('chk_timer_sunday').checked) {
            let c = new Date(now);
            while(c < target) { if(c.getDay()!==0) d++; c.setDate(c.getDate()+1); }
        } else d = Math.ceil(diff/86400000);
        output.textContent = `å‰© ${d} å¤©`;
    } else {
        output.textContent = `é ${Math.ceil(Math.abs(diff)/86400000)} å¤©`;
    }
}

// --- è³‡æ–™æ“ä½œ ---
function addEvent() {
    let title = document.getElementById('t_title').value.trim();
    if(!title) return alert('è«‹è¼¸å…¥æ¡ˆå');
    
    addPendingItem({
        id: 'p_' + Date.now(),
        title: title,
        cat: document.getElementById('t_cat').value,
        note: document.getElementById('t_note').value,
        days: parseInt(document.getElementById('t_days').value) || 1,
        ppl: parseInt(document.getElementById('t_ppl').value) || 1,
        color: curColor
    });
    
    document.getElementById('t_title').value = '';
    document.getElementById('t_note').value = '';
    if(isMobile()) toggleSidebar(); // æ–°å¢å¾Œé—œé–‰å´é‚Šæ¬„
}

function addPendingItem(item) {
    window.pendingList.unshift(item); 
    window.saveToCloud(); 
    window.renderPending();
}

function removePending(id) {
    window.pendingList = window.pendingList.filter(x => x.id !== id);
    window.renderPending();
}

function saveListOrder() {
    let listEl = document.getElementById('external-events');
    let newOrderIds = Array.from(listEl.children).map(el => el.getAttribute('data-id'));
    let newList = [];
    newOrderIds.forEach(id => {
        let item = window.pendingList.find(x => x.id === id);
        if(item) newList.push(item);
    });
    let filter = document.getElementById('filter_cat').value;
    if(filter !== 'ALL') {
        let hidden = window.pendingList.filter(x => x.cat !== filter);
        newList = newList.concat(hidden);
    }
    window.pendingList = newList;
    window.saveToCloud();
}

window.renderPending = function() {
    let listEl = document.getElementById('external-events');
    listEl.innerHTML = '';
    let filter = document.getElementById('filter_cat').value;
    
    window.pendingList.forEach(item => {
        if(filter !== 'ALL' && item.cat !== filter) return;
        let div = document.createElement('div');
        div.className = 'fc-event'; div.setAttribute('data-id', item.id); div.style.borderLeftColor = item.color;
        div.onclick = (e) => { if(!e.target.classList.contains('del-btn')) openEdit(item, 'list'); };
        
        div.setAttribute('data-event', JSON.stringify({
            id: 'evt_' + item.id, title: item.title, backgroundColor: item.color, borderColor: item.color,
            extendedProps: { sid: item.id, cat: item.cat, note: item.note, days: item.days, ppl: item.ppl }
        }));
        
        div.innerHTML = `
            <div class="del-btn" onclick="event.stopPropagation(); if(confirm('åˆªé™¤?')) { removePending('${item.id}'); window.saveToCloud(); }">Ã—</div>
            <div class="event-content">
                <div class="event-title">${item.title}</div>
                <div class="event-meta"><span class="badge">${item.cat}</span> <span>${item.days}å¤©</span> <span>${item.ppl}äºº</span></div>
                ${item.note ? `<div style="font-size:0.75rem; color:#999;">${item.note}</div>` : ''}
            </div>`;
        listEl.appendChild(div);
    });
}

// --- ç·¨è¼¯åŠŸèƒ½ ---
function openEdit(obj, source) {
    if(isMobile()) { 
        const sidebar = document.getElementById('sidebar');
        if(!sidebar.classList.contains('open')) toggleSidebar();
    }
    editObj = obj; editSource = source;
    document.getElementById('add-box').style.display = 'none';
    document.getElementById('edit-box').style.display = 'block';
    document.getElementById('btn-del-cal').style.display = (source === 'calendar') ? 'inline-block' : 'none';
    
    let p = (source === 'calendar') ? obj.extendedProps : obj;
    document.getElementById('e_title').value = (source === 'calendar') ? obj.title : obj.title;
    document.getElementById('e_cat').value = p.cat || 'å¯å®‰æ’';
    document.getElementById('e_note').value = p.note || '';
    document.getElementById('e_days').value = p.days || 1;
    document.getElementById('e_ppl').value = p.ppl || 1;
    let color = (source === 'calendar') ? obj.backgroundColor : obj.color;
    editCurColor = color;
    setupColors('edit-color-row', (c) => editCurColor = c, color);
}

function confirmUpdate() {
    if(!editObj) return;
    let title = document.getElementById('e_title').value;
    let cat = document.getElementById('e_cat').value;
    let note = document.getElementById('e_note').value;
    let days = parseInt(document.getElementById('e_days').value);
    let ppl = parseInt(document.getElementById('e_ppl').value);
    
    if(editSource === 'calendar') {
        editObj.setProp('title', title); editObj.setProp('backgroundColor', editCurColor); editObj.setProp('borderColor', editCurColor);
        let newP = { cat, note, days, ppl, sid: editObj.extendedProps.sid };
        editObj.setExtendedProp('cat', cat); editObj.setExtendedProp('note', note);
        editObj.setExtendedProp('days', days); editObj.setExtendedProp('ppl', ppl);
        if(editObj.start && document.getElementById('chk_schedule_sunday').checked) calcWorkDays({ event: editObj, extendedProps: newP });
        window.saveToCloud();
    } else {
        let item = window.pendingList.find(x => x.id === editObj.id);
        if(item) {
            item.title = title; item.cat = cat; item.note = note;
            item.days = days; item.ppl = ppl; item.color = editCurColor;
            window.saveToCloud(); window.renderPending();
        }
    }
    hideEditForm();
}

function hideEditForm() {
    document.getElementById('add-box').style.display = 'block';
    document.getElementById('edit-box').style.display = 'none';
    editObj = null;
    if(isMobile()) toggleSidebar(); // æ‰‹æ©Ÿä¸Šç·¨è¼¯å®Œè‡ªå‹•ç¸®å›
}

function deleteFromCalendar() {
    if(confirm('ç¢ºå®šå¾è¡Œäº‹æ›†åˆªé™¤ï¼Ÿ')) { editObj.remove(); window.saveToCloud(); hideEditForm(); }
}

function initColors() { setupColors('color-row', (c) => curColor = c, curColor); }
function setupColors(id, callback, defaultColor) {
    let box = document.getElementById(id); box.innerHTML = '';
    COLORS.forEach((c, i) => {
        let d = document.createElement('div');
        d.className = 'color-dot ' + ((defaultColor && sameColor(c, defaultColor)) || (!defaultColor && i===0) ? 'active' : '');
        d.style.backgroundColor = c;
        d.onclick = () => { Array.from(box.children).forEach(x => x.classList.remove('active')); d.classList.add('active'); callback(c); };
        box.appendChild(d);
    });
}
function sameColor(a, b) { return a.toLowerCase() === b.toLowerCase() || rgbToHex(a) === b.toLowerCase(); }
function rgbToHex(rgb) { if(rgb.startsWith('#')) return rgb; return '#000000'; } 
function initEnterKey() { document.querySelectorAll('.enter-submit').forEach(el => { el.onkeypress = (e) => { if(e.key==='Enter') addEvent(); }; }); }
</script>
</body>
</html>