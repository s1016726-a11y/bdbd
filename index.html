<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ’å–®ç®¡ç†ç³»çµ± V32 (å›åˆ°ä»Šå¤©æŒ‰éˆ•ç‰ˆ)</title>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

<style>
  /* --- 1. å…¨å±€è¨­å®š --- */
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; background: #f4f6f9; overflow: hidden; position: relative; }
  
  /* å·¦å´æ¬„ */
  #sidebar {
    width: 320px; background: white; border-right: 1px solid #ddd; display: flex;
    flex-direction: column; padding: 15px; z-index: 2000; 
    flex-shrink: 0; 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
    position: relative; height: 100%;
  }
  
  /* å³å´è¡Œäº‹æ›†å€ */
  #calendar-wrap { flex: 1; padding: 15px; display: flex; flex-direction: column; position: relative; overflow: hidden;}
  #calendar { background: white; padding: 10px; border-radius: 8px; flex: 1; box-shadow: 0 0 15px rgba(0,0,0,0.05); }

  /* é›²ç«¯ç‹€æ…‹ç‡ˆ */
  #cloud-status { font-size: 0.8rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; float:right;}

  /* --- 2. å…ƒä»¶æ¨£å¼ --- */
  h2 { margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
  
  .form-box { background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #e9ecef; margin-bottom: 10px; }
  .input-row { margin-bottom: 8px; }
  input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
  
  .labeled-input { display: flex; align-items: center; background: white; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
  .labeled-input span { background: #e9ecef; padding: 8px; font-size: 0.85rem; color: #555; font-weight: bold; border-right: 1px solid #ccc; white-space: nowrap;}
  .labeled-input input { border: none; padding: 8px; width: 100%; outline: none; }

  .color-row { display: flex; gap: 8px; justify-content: center; margin-bottom: 10px; }
  .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
  .color-dot.active { border-color: #333; transform: scale(1.15); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  button.btn-main { width: 100%; background: #0d6efd; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem;}
  button.btn-main:hover { background: #0b5ed7; }
  .btn-group { display: flex; gap: 5px; margin-top: 10px; }

  .settings-box { background: #eef2f7; padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 0.85rem; font-weight: bold; color: #333;}
  .settings-box label { cursor: pointer; display: flex; align-items: center; gap: 5px; }
  #current-user-display { display: block; margin-top: 2px; font-size: 0.8rem; color: #0d6efd; }
  
  .filter-select { margin-bottom: 10px; background-color: #fff3cd; font-weight: bold; color: #856404; }
  /* ç¢ºä¿æ¸…å–®å€åŸŸä½”æ»¿å‰©é¤˜ç©ºé–“ä¸¦ç¨ç«‹æ²å‹• */
  #external-events { flex: 1; overflow-y: auto; padding-right: 5px; padding-bottom: 50px; }
  
  /* å¡ç‰‡æ¨£å¼ - V31 å„ªåŒ–ï¼šç§»é™¤ touch-action é¿å…å¹²æ“¾æ‰‹æ©Ÿæ²å‹• */
  .fc-event { cursor: grab; padding: 10px; margin-bottom: 8px; background: white; border: 1px solid #ddd; border-left-width: 5px; border-radius: 4px; position: relative; user-select: none; /* touch-action: manipulation; */ }
  .event-content { padding-right: 20px; } 
  .event-title { font-weight: bold; font-size: 1rem; color: #333; }
  .event-meta { font-size: 0.75rem; color: #666; margin-top: 2px; display: flex; gap: 5px; flex-wrap: wrap;}
  .del-btn { position: absolute; top: 8px; right: 8px; color: #ff6b6b; cursor: pointer; font-weight: bold; padding: 5px; }

  /* é ‚éƒ¨é¢æ¿ */
  #top-panel { position: absolute; top: 15px; right: 20px; z-index: 100; background: white; padding: 6px 12px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #ddd; display: flex; gap: 15px; align-items: center; font-size: 0.9rem; }
  .countdown-wrap { display: flex; align-items: center; gap: 5px; padding-left: 0px;}
  #countdown_output { font-weight: bold; color: #0d6efd; min-width: 60px; text-align: center; }

  /* FullCalendar æ¨£å¼è¦†è“‹ */
  .fc-event { font-size: 11px !important; border: none !important; }
  .fc-event-main-frame { padding: 2px; height: 100%; display: flex; flex-direction: column; justify-content: center; }
  .fc-col-header-cell { color: #333 !important; padding: 5px 0 !important; }
  .fc-col-header-cell-c a { display: block !important; font-weight: bold; color: inherit; text-decoration: none;}
  .fc-daygrid-day-number { color: #333 !important; font-weight: bold; font-size: 0.9rem; padding: 2px 4px; z-index: 2; text-decoration: none;}
  .fc-toolbar-title { font-size: 1.2rem !important; }
  .cal-row { display: flex; justify-content: space-between; align-items: center; width: 100%; overflow: hidden; }
  .cal-title { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 4px; }
  .cal-meta { font-size: 10px; white-space: nowrap; opacity: 0.9; flex-shrink: 0; }

  /* æµ®å‹•æŒ‰éˆ• (FAB) */
  #fab {
      display: none; 
      position: fixed; bottom: 25px; right: 25px; z-index: 2100;
      width: 56px; height: 56px; border-radius: 50%; background: #0d6efd;
      color: white; border: none; font-size: 32px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer;
      align-items: center; justify-content: center;
      transition: transform 0.2s;
  }
  #fab:active { transform: scale(0.95); }

  /* æ‰‹æ©Ÿé®ç½©å±¤ */
  #mobile-overlay {
      display: none; position: absolute; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); z-index: 1900; opacity: 0; transition: opacity 0.3s;
  }
  #mobile-overlay.visible { opacity: 1; }

  /* é»æ“Šæ’å–®æç¤º */
  #date-click-hint {
      margin-top: 0px; margin-bottom: 8px; padding: 8px; border-radius: 4px; 
      background: #f0f8ff; color: #0d6efd; font-weight: bold; font-size: 0.9rem; 
      border: 1px dashed #0d6efd; cursor: pointer;
  }
  #date-click-hint:hover { background: #e6f2ff; }

  @media (max-width: 768px) {
    body { flex-direction: column; }
    
    /* å´é‚Šæ¬„è®Šæˆæ»‘å‡ºå¼æŠ½å±œ */
    #sidebar { 
        position: absolute; top: 0; left: 0; 
        width: 85%; max-width: 320px; height: 100%; 
        transform: translateX(-100%); 
        box-shadow: 2px 0 12px rgba(0,0,0,0.2);
    }
    #sidebar.open { transform: translateX(0); }

    /* è¡Œäº‹æ›†å…¨å± */
    #calendar-wrap { padding: 0; height: 100%; }
    #calendar { border-radius: 0; padding: 0 5px; box-shadow: none; }
    .fc-header-toolbar { margin-bottom: 10px !important; padding-top: 10px; }

    /* é¡¯ç¤º FAB */
    #fab { display: flex; }
    
    /* èª¿æ•´é ‚éƒ¨é¢æ¿ä½ç½® */
    #top-panel { position: static; margin: 0; padding: 10px; border-bottom: 1px solid #eee; border-radius: 0; box-shadow: none; width: 100%; justify-content: flex-end; }
    .countdown-wrap { border-left: none; padding-left: 0; }
    
    /* V30/V31 å„ªåŒ–ï¼šæ‰‹æ©Ÿäº‹ä»¶é¡¯ç¤º */
    .fc-event { 
        padding: 1px 3px !important; 
        margin-bottom: 2px !important; 
        font-size: 12px !important; 
    }
    .cal-title { 
        font-weight: normal; 
        font-size: 12px !important;
    }
    .cal-meta { display: none; } 
  }
</style>
</head>
<body>

<button id="fab" onclick="toggleSidebar()">ï¼‹</button>
<div id="mobile-overlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <h2> æ’å–® V32 <span id="cloud-status">é€£ç·šä¸­...</span></h2>

  <div id="date-click-hint" style="display:none;" onclick="cancelDirectSchedule()"></div>

  <div id="add-box" class="form-box">
    <div class="input-row"><input id="t_title" class="enter-submit" type="text" placeholder="è¼¸å…¥æ¡ˆå"></div>
    <div class="input-row">
      <select id="t_cat" class="enter-submit">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="t_note" class="enter-submit" type="text" placeholder="å‚™è¨» (é¸å¡«)"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="t_days" class="enter-submit" type="number" min="1" value="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="t_ppl" class="enter-submit" type="number" min="1" value="1"></div>
    </div>
    <div class="color-row" id="color-row"></div>
    <button class="btn-main" id="btn-add-event" onclick="addEvent()">ï¼‹ æ–°å¢æ¡ˆä»¶ (Enter)</button>
  </div>

  <div id="edit-box" class="form-box" style="display:none; border: 2px solid #0d6efd;">
    <div style="color:#0d6efd; font-weight:bold; margin-bottom:5px;"> ğŸ“ ç·¨è¼¯æ¡ˆä»¶</div>
    <input type="hidden" id="e_id"><input type="hidden" id="e_source"> 
    <div class="input-row"><input id="e_title" type="text"></div>
    <div class="input-row">
      <select id="e_cat">
        <option value="å¯å®‰æ’">å¯å®‰æ’</option>
        <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
        <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
        <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
      </select>
    </div>
    <div class="input-row"><input id="e_note" type="text" placeholder="å‚™è¨»"></div>
    <div class="input-row" style="display:flex; gap:8px;">
      <div class="labeled-input" style="flex:1"><span>å¤©æ•¸</span><input id="e_days" type="number" min="1"></div>
      <div class="labeled-input" style="flex:1"><span>äººæ•¸</span><input id="e_ppl" type="number" min="1"></div>
    </div>
    <div class="color-row" id="edit-color-row"></div>
    <div class="btn-group">
      <button class="btn-main" onclick="confirmUpdate()">ç¢ºèª</button>
      <button class="btn-main" style="background:#dc3545; display:none;" id="btn-del-cal" onclick="deleteFromCalendar()">åˆªé™¤</button>
      <button class="btn-main" style="background:#6c757d" onclick="hideEditForm()">å–æ¶ˆ</button>
    </div>
  </div>

  <select id="filter_cat" class="filter-select" onchange="renderPending()">
    <option value="ALL">é¡¯ç¤ºå…¨éƒ¨</option>
    <option value="å¯å®‰æ’">å¯å®‰æ’</option>
    <option value="ç­‰å¾…ç¾å ´å·¥ç¨‹">ç­‰å¾…ç¾å ´å·¥ç¨‹</option>
    <option value="äº‹å…ˆæ‹†é™¤">äº‹å…ˆæ‹†é™¤</option>
    <option value="ç¶­ä¿®æ¡ˆä»¶">ç¶­ä¿®æ¡ˆä»¶</option>
  </select>

  <div id="external-events"></div>
</div>

<div id="calendar-wrap">
  <div id="top-panel">
    <div class="countdown-wrap">
      <span> ğŸ“… å€’æ•¸è‡³ </span>
      <input type="date" id="countdown_date" style="width:auto; padding:2px;" onchange="updateCountdown(true)">
      <span id="countdown_output">...</span>
    </div>
  </div>
  <div id="calendar"></div>
</div>

<script type="module">
// ------------------------------------------------
// 1. Firebase åˆå§‹åŒ– & é˜²æŠ–å‹•å„ªåŒ–
// ------------------------------------------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCIqvMrXiRKl50Z_ZAZtn1UVAqpnnlnVmI",
  authDomain: "project-2936455536954733138.firebaseapp.com",
  projectId: "project-2936455536954733138",
  storageBucket: "project-2936455536954733138.firebasestorage.app",
  messagingSenderId: "248829609752",
  appId: "1:248829609752:web:de5e3882d215514d34406d"
};

let db;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    console.log("Firebase initialized");
} catch (e) {
    console.error("Firebase init failed:", e);
    document.getElementById('cloud-status').innerText = "è¨­å®šéŒ¯èª¤";
    document.getElementById('cloud-status').style.background = "#ffcccc";
}

// å•Ÿå‹•ç›£è½
if(db) {
    const statusEl = document.getElementById('cloud-status');
    onSnapshot(doc(db, "sch_system", "data"), (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            statusEl.innerText = "å·²åŒæ­¥"; statusEl.style.color = "green";
            
            // æ›´æ–°è³‡æ–™
            window.pendingList = data.pending || [];
            window.renderPending();
            
            if(window.calendarAPI) {
                window.calendarAPI.removeAllEvents();
                window.calendarAPI.addEventSource(data.events || []);
            }

            if(data.countdown) {
                document.getElementById('countdown_date').value = data.countdown;
                window.updateCountdown(false); 
            }
        } else { statusEl.innerText = "ç„¡è³‡æ–™"; }
    });
}

// â˜…â˜…â˜… é˜²æŠ–å‹•å„²å­˜é‚è¼¯ â˜…â˜…â˜…
let saveTimer = null;

window.saveToCloud = async function() {
    if (!db) return;
    const statusEl = document.getElementById('cloud-status');
    
    // 1. ä»‹é¢ç«‹åˆ»åæ‡‰
    statusEl.innerText = "å¾…å­˜...";
    statusEl.style.color = "orange";

    // 2. å¦‚æœé‚„æœ‰æœªåŸ·è¡Œçš„å„²å­˜ï¼Œå–æ¶ˆå®ƒ (é‡æ–°è¨ˆæ™‚)
    if(saveTimer) clearTimeout(saveTimer);

    // 3. è¨­å®š 1 ç§’å¾ŒåŸ·è¡Œå„²å­˜
    saveTimer = setTimeout(async () => {
        statusEl.innerText = "ä¸Šå‚³ä¸­...";
        const currentPending = window.pendingList || [];
        const currentEvents = window.calendarAPI ? window.calendarAPI.getEvents().map(e => ({
            id: e.id, title: e.title, start: e.startStr, end: e.endStr, allDay: e.allDay,
            backgroundColor: e.backgroundColor, extendedProps: e.extendedProps
        })) : [];
        const currentCountdown = document.getElementById('countdown_date').value;

        try {
            await setDoc(doc(db, "sch_system", "data"), {
                pending: currentPending, events: currentEvents, countdown: currentCountdown, lastUpdate: new Date().toISOString()
            });
            statusEl.innerText = "å·²åŒæ­¥";
            statusEl.style.color = "green";
        } catch (e) {
            console.error("å¯«å…¥å¤±æ•—", e); 
            statusEl.innerText = "å¤±æ•—";
            statusEl.style.color = "red";
        }
    }, 1000); // å»¶é² 1000 æ¯«ç§’ (1ç§’)
};
</script>

<script>
// ------------------------------------------------
// 2. é‚è¼¯æ§åˆ¶
// ------------------------------------------------
const COLORS = ['#3788d8', '#28a745', '#dc3545', '#ffc107', '#6610f2', '#fd7e14'];
let curColor = COLORS[0], editCurColor = COLORS[0]; 
let calendarAPI, sortableInstance;
window.pendingList = []; 
let editObj = null, editSource = '';
let selectedDate = null; // ç”¨æ–¼å„²å­˜æ—¥æ›†é»æ“Šçš„æ—¥æœŸ

document.addEventListener('DOMContentLoaded', () => {
    initColors();
    initEnterKey();
    
    let listEl = document.getElementById('external-events');
    sortableInstance = Sortable.create(listEl, {
        animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
        forceFallback: true, onEnd: saveListOrder
    });

    new FullCalendar.Draggable(listEl, {
        itemSelector: '.fc-event',
        eventData: (el) => JSON.parse(el.getAttribute('data-event'))
    });
    
    let calEl = document.getElementById('calendar');
    calendarAPI = new FullCalendar.Calendar(calEl, {
        // â˜…â˜…â˜… V32 è®Šæ›´ï¼šåœ¨ left å€å¡ŠåŠ å…¥ 'today' æŒ‰éˆ• â˜…â˜…â˜…
        headerToolbar: { 
            left: 'customMenu,prev,next,today', 
            center: 'title', 
            right: 'dayGridMonth' 
        },
        customButtons: {
            customMenu: { text: 'â˜°', click: toggleSidebar }
        },
        locale: 'zh-tw', editable: true, droppable: true,
        dayMaxEvents: 4, height: '100%', contentHeight: 'auto',
        initialEvents: [], 
        
        // â˜…â˜…â˜… é»æ“Šæ’å–®åŠŸèƒ½ â˜…â˜…â˜…
        dateClick: (info) => {
            selectedDate = info.dateStr; // é–å®šé»æ“Šçš„æ—¥æœŸ
            document.getElementById('date-click-hint').innerText = `âœ… é–å®šæ—¥æœŸï¼š${selectedDate} (é»æ“Šå–æ¶ˆ)`;
            document.getElementById('date-click-hint').style.display = 'block';
            document.getElementById('btn-add-event').innerText = `ï¼‹ ç›´æ¥æ’å–®è‡³ ${selectedDate}`;

            // å¼·åˆ¶æ‰“é–‹æ–°å¢æ¡ˆä»¶å€å¡Š
            document.getElementById('add-box').style.display = 'block';
            document.getElementById('edit-box').style.display = 'none';
            document.getElementById('t_title').focus();
            if(isMobile()) toggleSidebar();
        },
        
        eventReceive: (info) => {
            if(!info.event.id) info.event.setProp('id', 'evt_' + Date.now());
            removePending(info.event.extendedProps.sid); 
            window.saveToCloud();
        },
        eventChange: (info) => {
            window.saveToCloud();
        },
        eventClick: (info) => openEdit(info.event, 'calendar'),
        eventDragStop: (info) => {
            let sidebar = document.getElementById('sidebar');
            let rect = sidebar.getBoundingClientRect();
            let x = info.jsEvent.clientX, y = info.jsEvent.clientY;
            if (sidebar.offsetParent !== null && x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                if(confirm('ç¢ºå®šé€€å›æ¸…å–®ï¼Ÿ')) {
                    let p = info.event.extendedProps;
                    addPendingItem({
                        id: p.sid || ('p_' + Date.now()), title: info.event.title, 
                        cat: p.cat, note: p.note, days: p.days, ppl: p.ppl, color: info.event.backgroundColor
                    });
                    info.event.remove();
                    window.saveToCloud();
                }
            }
        },
        // V30 å„ªåŒ–ï¼šæ ¹æ“šè£ç½®èª¿æ•´äº‹ä»¶é¡¯ç¤ºå…§å®¹
        eventContent: (arg) => {
            let p = arg.event.extendedProps;
            let textColor = (arg.event.backgroundColor === '#ffc107') ? 'black' : 'white';
            let title = arg.event.title;
            let content;
            
            if (isMobile()) {
                // æ‰‹æ©Ÿç‰ˆï¼šåªé¡¯ç¤ºæ¡ˆå
                content = `<div class="cal-row" style="color:${textColor}"><div class="cal-title">${title}</div></div>`;
            } else {
                // PCç‰ˆï¼šé¡¯ç¤ºæ¡ˆåå’Œå¤©æ•¸/äººæ•¸
                let meta = `<div class="cal-meta"> ${p.days||1}å¤© ${p.ppl||1}äºº</div>`;
                content = `<div class="cal-row" style="color:${textColor}"><div class="cal-title">${title}</div>${meta}</div>`;
            }

            return { html: content };
        },
        dayCellContent: (arg) => { 
            if (arg.dayNumberText) return { html: `<span class="fc-daygrid-day-number">${arg.dayNumberText.replace('æ—¥', '')}</span>` };
            return arg.domNodes;
        },
        dayHeaderFormat: { weekday: 'short' }
    });
    window.calendarAPI = calendarAPI;
    calendarAPI.render();
});

function isMobile() { return window.matchMedia("(max-width: 768px)").matches; }

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('mobile-overlay');
    
    if (!isMobile()) { 
         sidebar.style.display = (sidebar.style.display === 'none') ? 'flex' : 'none';
         setTimeout(() => calendarAPI.updateSize(), 200);
         return;
    }

    const isOpen = sidebar.classList.contains('open');
    if (isOpen) {
        sidebar.classList.remove('open');
        overlay.classList.remove('visible');
        setTimeout(() => overlay.style.display = 'none', 300);
    } else {
        overlay.style.display = 'block';
        setTimeout(() => {
            sidebar.classList.add('open');
            overlay.classList.add('visible');
        }, 10);
        document.getElementById('add-box').style.display = 'block';
        document.getElementById('edit-box').style.display = 'none';
        if (selectedDate) cancelDirectSchedule(false);
    }
}

window.updateCountdown = function(isWrite = false) {
    if(isWrite && window.saveToCloud) window.saveToCloud();
    let input = document.getElementById('countdown_date');
    let output = document.getElementById('countdown_output');
    if(!input.value) { output.textContent = "..."; return; }
    
    let target = new Date(input.value); target.setHours(0,0,0,0);
    let now = new Date(); now.setHours(0,0,0,0);
    let diff = target.getTime() - now.getTime();
    
    let d = Math.ceil(diff/86400000);
    
    if(diff >= 0) {
        output.textContent = `å‰© ${d} å¤©`;
    } else {
        output.textContent = `é ${Math.ceil(Math.abs(diff)/86400000)} å¤©`;
    }
}

function calculateEndDate(startDateStr, days) {
    let date = new Date(startDateStr);
    date.setDate(date.getDate() + days);
    return date.toISOString().split('T')[0];
}

function cancelDirectSchedule(closeSidebar = true) {
    selectedDate = null;
    document.getElementById('date-click-hint').style.display = 'none';
    document.getElementById('btn-add-event').innerText = 'ï¼‹ æ–°å¢æ¡ˆä»¶ (Enter)';
    document.getElementById('t_title').focus();
    if(closeSidebar && isMobile()) toggleSidebar();
}

function addEvent() {
    let title = document.getElementById('t_title').value.trim();
    if(!title) return alert('è«‹è¼¸å…¥æ¡ˆå');
    
    let eventData = {
        id: 'p_' + Date.now(),
        title: title,
        cat: document.getElementById('t_cat').value,
        note: document.getElementById('t_note').value,
        days: parseInt(document.getElementById('t_days').value) || 1,
        ppl: parseInt(document.getElementById('t_ppl').value) || 1,
        color: curColor
    };
    
    if (selectedDate) {
        // é»æ“Šæ’å–®æ¨¡å¼ï¼šç›´æ¥åŠ å…¥è¡Œäº‹æ›†
        calendarAPI.addEvent({
            id: 'evt_' + eventData.id,
            title: eventData.title,
            start: selectedDate,
            end: calculateEndDate(selectedDate, eventData.days),
            allDay: true,
            backgroundColor: eventData.color,
            borderColor: eventData.color,
            extendedProps: { sid: eventData.id, cat: eventData.cat, note: eventData.note, days: eventData.days, ppl: eventData.ppl }
        });
        cancelDirectSchedule(false); // å–æ¶ˆé–å®šæ—¥æœŸï¼Œä½†ä¸é—œé–‰å´é‚Šæ¬„
        window.saveToCloud();
    } else {
        // é è¨­æ¨¡å¼ï¼šåŠ å…¥å¾…è¾¦æ¸…å–®
        addPendingItem(eventData);
    }
    
    document.getElementById('t_title').value = '';
    document.getElementById('t_note').value = '';
    if(isMobile() && !selectedDate) toggleSidebar(); 
}

function addPendingItem(item) {
    window.pendingList.unshift(item); 
    window.saveToCloud(); 
    window.renderPending();
}

function removePending(id) {
    window.pendingList = window.pendingList.filter(x => x.id !== id);
    window.renderPending();
}

function saveListOrder() {
    let listEl = document.getElementById('external-events');
    let newOrderIds = Array.from(listEl.children).map(el => el.getAttribute('data-id'));
    let newList = [];
    newOrderIds.forEach(id => {
        let item = window.pendingList.find(x => x.id === id);
        if(item) newList.push(item);
    });
    let filter = document.getElementById('filter_cat').value;
    if(filter !== 'ALL') {
        let hidden = window.pendingList.filter(x => x.cat !== filter);
        newList = newList.concat(hidden);
    }
    window.pendingList = newList;
    window.saveToCloud();
}

window.renderPending = function() {
    let listEl = document.getElementById('external-events');
    listEl.innerHTML = '';
    let filter = document.getElementById('filter_cat').value;
    
    window.pendingList.forEach(item => {
        if(filter !== 'ALL' && item.cat !== filter) return;
        let div = document.createElement('div');
        div.className = 'fc-event'; div.setAttribute('data-id', item.id); div.style.borderLeftColor = item.color;
        div.onclick = (e) => { if(!e.target.classList.contains('del-btn')) openEdit(item, 'list'); };
        
        div.setAttribute('data-event', JSON.stringify({
            id: 'evt_' + item.id, title: item.title, backgroundColor: item.color, borderColor: item.color,
            extendedProps: { sid: item.id, cat: item.cat, note: item.note, days: item.days, ppl: item.ppl }
        }));
        
        div.innerHTML = `
            <div class="del-btn" onclick="event.stopPropagation(); if(confirm('åˆªé™¤?')) { removePending('${item.id}'); window.saveToCloud(); }">Ã—</div>
            <div class="event-content">
                <div class="event-title">${item.title}</div>
                <div class="event-meta"><span class="badge">${item.cat}</span> <span>${item.days}å¤©</span> <span>${item.ppl}äºº</span></div>
                ${item.note ? `<div style="font-size:0.75rem; color:#999;">${item.note}</div>` : ''}
            </div>`;
        listEl.appendChild(div);
    });
}

function openEdit(obj, source) {
    if(isMobile()) { 
        const sidebar = document.getElementById('sidebar');
        if(!sidebar.classList.contains('open')) toggleSidebar();
    }
    
    if (selectedDate) cancelDirectSchedule(false);

    editObj = obj; editSource = source;
    document.getElementById('add-box').style.display = 'none';
    document.getElementById('edit-box').style.display = 'block';
    document.getElementById('btn-del-cal').style.display = (source === 'calendar') ? 'inline-block' : 'none';
    
    let p = (source === 'calendar') ? obj.extendedProps : obj;
    document.getElementById('e_title').value = (source === 'calendar') ? obj.title : obj.title;
    document.getElementById('e_cat').value = p.cat || 'å¯å®‰æ’';
    document.getElementById('e_note').value = p.note || '';
    document.getElementById('e_days').value = p.days || 1;
    document.getElementById('e_ppl').value = p.ppl || 1;
    let color = (source === 'calendar') ? obj.backgroundColor : obj.color;
    editCurColor = color;
    setupColors('edit-color-row', (c) => editCurColor = c, color);
}

function confirmUpdate() {
    if(!editObj) return;
    let title = document.getElementById('e_title').value;
    let cat = document.getElementById('e_cat').value;
    let note = document.getElementById('e_note').value;
    let days = parseInt(document.getElementById('e_days').value) || 1;
    let ppl = parseInt(document.getElementById('e_ppl').value) || 1;
    
    if(editSource === 'calendar') {
        editObj.setProp('title', title); editObj.setProp('backgroundColor', editCurColor); editObj.setProp('borderColor', editCurColor);
        editObj.setExtendedProp('cat', cat); editObj.setExtendedProp('note', note);
        editObj.setExtendedProp('days', days); editObj.setExtendedProp('ppl', ppl);
        // ç¢ºä¿ days >= 1 æ™‚ï¼ŒçµæŸæ—¥æœŸè¢«æ­£ç¢ºè¨­ç½® (start + days)
        if(editObj.start && days >= 1) editObj.setEnd(calculateEndDate(editObj.startStr, days));
        window.saveToCloud();
    } else {
        let item = window.pendingList.find(x => x.id === editObj.id);
        if(item) {
            item.title = title; item.cat = cat; item.note = note;
            item.days = days; item.ppl = ppl; item.color = editCurColor;
            window.saveToCloud(); window.renderPending();
        }
    }
    hideEditForm();
}

function hideEditForm() {
    document.getElementById('add-box').style.display = 'block';
    document.getElementById('edit-box').style.display = 'none';
    editObj = null;
    if(isMobile()) toggleSidebar(); 
}

function deleteFromCalendar() {
    if(confirm('ç¢ºå®šå¾è¡Œäº‹æ›†åˆªé™¤ï¼Ÿ')) { editObj.remove(); window.saveToCloud(); hideEditForm(); }
}

function initColors() { setupColors('color-row', (c) => curColor = c, curColor); }
function setupColors(id, callback, defaultColor) {
    let box = document.getElementById(id); box.innerHTML = '';
    COLORS.forEach((c, i) => {
        let d = document.createElement('div');
        d.className = 'color-dot ' + ((defaultColor && sameColor(c, defaultColor)) || (!defaultColor && i===0) ? 'active' : '');
        d.style.backgroundColor = c;
        d.onclick = () => { Array.from(box.children).forEach(x => x.classList.remove('active')); d.classList.add('active'); callback(c); };
        box.appendChild(d);
    });
}
function sameColor(a, b) { return a.toLowerCase() === b.toLowerCase() || rgbToHex(a) === b.toLowerCase(); }
function rgbToHex(rgb) { if(rgb.startsWith('#')) return rgb; return '#000000'; } 
function initEnterKey() { document.querySelectorAll('.enter-submit').forEach(el => { el.onkeypress = (e) => { if(e.key==='Enter') addEvent(); }; }); }
</script>
</body>
</html>
